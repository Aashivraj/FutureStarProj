{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}
{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<!-- Plugins css Ends--> 
{% endblock %} 

{% block content %}
<style>
    /* Modal background overlay */
    .modal {
        display: none !important;
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Modal content */
    .modal-content {
        background-color: #fff;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px; /* Rounded corners */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 400px; /* Fixed width */
        max-width: 90%; /* Responsive max width */
        height: auto; /* Auto height */
        box-sizing: border-box; /* Ensure padding is included in the height */
    }

    /* The Close Button */
    .close {
        color: #aaa;
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: #333;
        text-decoration: none;
    }

    /* Form controls */
    .form-label {
        font-weight: bold;
    }

    .form-control {
        border-radius: 4px;
        border: 1px solid #ddd;
        padding: 8px;
        width: 100%;
    }

    .btn-primary {
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 10px 15px;
        cursor: pointer;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
        .modal-content {
            width: 90%;
        }
    }
</style>
<div class="page-body">
   <div class="container-fluid">
      <div class="row">
         <!-- User List Template -->
         <div class="col-sm-12">
            <div class="card">
               <div class="card-header pb-0 card-no-border">
                  <h3>User List</h3>
                  <span>This table lists all registered users with options to edit or delete them.</span>
               </div>
               <div class="card-body">
                  <div class="table-responsive">
                     <table class="display" id="basic-1">
                        <thead>
                           <tr>
                              <th>Username</th>
                              <th>First Name</th>
                              <th>Last Name</th>
                              <th>Email</th>
                              <th>Phone</th>
                              <th>Role</th>
                              <th>Actions</th>
                           </tr>
                        </thead>
                        <tbody> 
                           {% for user in users %} 
                           <tr>
                              <td>{{ user.username }}</td>
                              <td>{{ user.first_name }}</td>
                              <td>{{ user.last_name }}</td>
                              <td>{{ user.email }}</td>
                              <td>{{ user.phone }}</td> 
                              {% if user.role %}
                              <td>{{ user.role.name }}</td>
                              {% else %}
                              <td>No Role Assigned</td>
                              {% endif %}
                              <td>
                                 <ul class="action">
                                    <li class="edit">
                                       <a href="#" data-id="{{ user.id }}" class="edit-btn">
                                          <i class="icon-pencil-alt"></i>
                                       </a>
                                    </li>
                                    <li class="delete">
                                       <a href="#" data-id="{{ user.id }}" class="delete-btn">
                                          <i class="icon-trash"></i>
                                       </a>
                                    </li>
                                 </ul>
                              </td>
                           </tr> 
                           {% endfor %} 
                        </tbody>
                     </table>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit User</h2>
        <form id="editUserForm" method="post">
            {% csrf_token %}
            <input type="hidden" name="user_id" id="user_id">
            <div class="mb-3">
                <label class="form-label" for="first_name">First Name</label>
                <input class="form-control" id="first_name" name="first_name" type="text">
            </div>
            <div class="mb-3">
                <label class="form-label" for="last_name">Last Name</label>
                <input class="form-control" id="last_name" name="last_name" type="text">
            </div>
            <div class="mb-3">
                <label class="form-label" for="email">Email</label>
                <input class="form-control" id="email" name="email" type="email">
            </div>
            <div class="mb-3">
                <label class="form-label" for="phone">Phone</label>
                <input class="form-control" id="phone" name="phone" type="text">
            </div>
            <div class="mb-3">
                <label class="form-label" for="role">Role</label>
                <select class="form-control" id="role" name="role">
                    {% for role in roles %}
                        <option value="{{ role.id }}">{{ role.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button class="btn btn-primary" type="submit">Save</button>
        </form>
    </div>
</div>



{% endblock %}

{% block scriptcontent %}
<!-- Plugins JS start-->
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js'%}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js'%}"></script>
<script src="{% static 'assets/js/tooltip-init.js'%}"></script>
<!-- Plugins JS Ends-->

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Edit button click handler
    document.querySelectorAll('.edit-btn').forEach(function (button) {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            var userId = this.getAttribute('data-id');
            
            // Fetch user details
            fetch('/users/' + userId + '/edit/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('user_id').value = data.id;
                    document.getElementById('first_name').value = data.first_name;
                    document.getElementById('last_name').value = data.last_name;
                    document.getElementById('email').value = data.email;
                    document.getElementById('phone').value = data.phone;
                    
                    // Set selected role
                    var roleSelect = document.getElementById('role');
                    for (var i = 0; i < roleSelect.options.length; i++) {
                        if (roleSelect.options[i].value == data.role) {
                            roleSelect.options[i].selected = true;
                            break;
                        }
                    }
                    
                    // Show modal
                    document.getElementById('editUserModal').style.display = 'flex';
                });
        });
    });

    // Modal close button
    document.querySelector('#editUserModal .close').addEventListener('click', function () {
        document.getElementById('editUserModal').style.display = 'none';
    });

    // Close modal when clicking outside of it
    window.addEventListener('click', function (e) {
        if (e.target === document.getElementById('editUserModal')) {
            document.getElementById('editUserModal').style.display = 'none';
        }
    });

    // Edit user form submit
    document.getElementById('editUserForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var formData = new FormData(this);
        fetch('/users/' + document.getElementById('user_id').value + '/update/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();  // Reload the page to see changes
            }
        });
    });

    // Delete button click handler
    document.querySelectorAll('.delete-btn').forEach(function (button) {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            var userId = this.getAttribute('data-id');

            if (confirm('Are you sure you want to delete this user?')) {
                fetch('/users/' + userId + '/delete/', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();  // Reload the page to see changes
                    }
                });
            }
        });
    });
});
</script>
{% endblock %}
